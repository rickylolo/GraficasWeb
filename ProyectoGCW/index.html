<!DOCTYPE html>
<html lang="ES">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Document</title>
  <style>
    body {
      margin: 0;
    }
  </style>
</head>

<body>
  <!-- <button id="button-login">Login Google</button>
  <button id="button-logout">Logout</button> -->
  <script type="module">
    import * as THREE from "./js/three.module.js";
    import {
      State,
      CharacterFSM,
      FiniteStateMachine,
      BasicCharacterControllerInput,
      BasicCharacterController,
      BasicCharacterControllerProxy,
      IdleState,
      RunState,
      WalkState,
      CharacterControllerDemo
    } from "./js/MainCharacter.js";
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.19.0/firebase-app.js";
    import {
      GoogleAuthProvider,
      signInWithPopup,
      getAuth,
      signOut,
    } from "https://www.gstatic.com/firebasejs/9.19.0/firebase-auth.js";

    import {
      getDatabase,
      ref,
      onValue,
      set,
    } from "https://www.gstatic.com/firebasejs/9.19.0/firebase-database.js";

    /*
        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyB-i-B3FuedTBzUg3zOrHoWvkiKdpX6Vnc",
          authDomain: "gcwproyecto-9df64.firebaseapp.com",
          databaseURL: "https://gcwproyecto-9df64-default-rtdb.firebaseio.com",
          projectId: "gcwproyecto-9df64",
          storageBucket: "gcwproyecto-9df64.appspot.com",
          messagingSenderId: "286044668722"
        };
    
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const provider = new GoogleAuthProvider();
        const db = getDatabase();
        const auth = getAuth();
        auth.languageCode = "es";
    
        //Buttons
        const buttonLogin = document.getElementById("button-login");
        const buttonLogout = document.getElementById("button-logout");
    
        buttonLogin.addEventListener("click", () => {
          login();
        });
    
        buttonLogout.addEventListener("click", () => {
          signOut(auth)
            .then(() => {
              // Sign-out successful.
              console.log("Sign-out successful");
            })
            .catch((error) => {
              // An error happened.
              console.log("An error happened");
            });
        });
    
        let currentUser;
        async function login() {
          await signInWithPopup(auth, provider)
            .then((result) => {
              // This gives you a Google Access Token. You can use it to access the Google API.
              const credential = GoogleAuthProvider.credentialFromResult(result);
              const token = credential.accessToken;
              // The signed-in user info.
              const user = result.user;
              currentUser = result.user;
              writeUserData(user.uid, { x: 0, z: 0 });
              // IdP data available using getAdditionalUserInfo(result)
              // ...
            })
            .catch((error) => {
              // Handle Errors here.
              const errorCode = error.code;
              const errorMessage = error.message;
              // The email of the user's account used.
              const email = error.customData.email;
              // The AuthCredential type that was used.
              const credential = GoogleAuthProvider.credentialFromError(error);
              // ...
            });
        }
    
        const starCountRef = ref(db, "jugadores/");
    
        onValue(starCountRef, (snapshot) => {
          const data = snapshot.val();
    
          Object.entries(data).forEach(([key, value]) => {
            const jugador = scene.getObjectByName(key);
            if (!jugador) {
              const geometry = new THREE.BoxGeometry(1, 1, 1);
              const material = new THREE.MeshPhongMaterial();
              const mesh = new THREE.Mesh(geometry, material);
              mesh.castShadow = true;
              mesh.position.set(value.x, 0, value.z);
              mesh.name = key;
              mesh.material.color = new THREE.Color(Math.random() * 0xffffff);
              scene.add(mesh);
            }
            scene.getObjectByName(key).position.x = value.x;
            scene.getObjectByName(key).position.z = value.z;
          });
        });
    
        function writeUserData(userId, position) {
          set(ref(db, "jugadores/" + userId), {
            x: position.x,
            z: position.z,
          });
        }
    
    */


    let _APP = null;

    window.addEventListener('DOMContentLoaded', () => {
      _APP = new CharacterControllerDemo();
    });


  </script>
</body>

</html>